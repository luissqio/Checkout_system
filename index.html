<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout Terminal</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background for terminal feel */
            color: #e2e8f0; /* Light text color */
        }
        .terminal-container {
            background-color: #2d3748; /* Slightly lighter dark gray for the terminal body */
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.4);
            border: 2px solid #4a5568;
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: auto auto 1fr auto auto; /* Header, scanner, cart, discount, controls */
            gap: 1.5rem;
            padding: 2rem;
            max-width: 1200px; /* Increased max-width for more space */
            width: 100%;
            min-height: 80vh;
        }

        @media (min-width: 768px) {
            .terminal-container {
                grid-template-columns: 1fr 1.5fr; /* Scanner on left, cart/receipt on right */
                grid-template-rows: auto 1fr auto; /* Header, main content, controls */
                height: 85vh; /* Fixed height for desktop */
            }
            .scanner-section {
                grid-column: 1 / 2;
                grid-row: 1 / 3; /* Span header and main content rows */
            }
            .cart-section {
                grid-column: 2 / 3;
                grid-row: 1 / 2; /* Span header and main content rows */
            }
            .discount-section {
                grid-column: 2 / 3;
                grid-row: 2 / 3; /* Below cart on desktop */
                align-self: start; /* Align to top of its grid cell */
            }
            .controls-section {
                grid-column: 1 / 3; /* Span both columns */
                grid-row: 3 / 4;
            }
        }

        .terminal-header {
            grid-column: 1 / -1; /* Span all columns */
            text-align: center;
            padding-bottom: 1rem;
            border-bottom: 1px solid #4a5568;
        }

        #interactive.viewport {
            position: relative;
            width: 100%;
            aspect-ratio: 4/3; /* Maintain aspect ratio for video feed */
            margin: 0 auto;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5); /* Inner shadow for screen effect */
            background-color: #000; /* Black background for video area */
        }
        #interactive.viewport canvas, #interactive.viewport video {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
        }
        .drawingBuffer {
            position: absolute;
            top: 0;
            left: 0;
        }
        .scanner-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80%;
            height: 2px;
            background-color: #ef4444;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 15px 5px rgba(239, 68, 68, 0.7);
            animation: pulse 1.5s infinite alternate;
        }

        @keyframes pulse {
            0% {
                opacity: 0.7;
                transform: translate(-50%, -50%) scaleX(0.8);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scaleX(1);
            }
        }

        .terminal-screen {
            background-color: #1a202c; /* Dark screen background */
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.7); /* Deep inner shadow */
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Push total to bottom */
            overflow-y: auto; /* Scroll for many items */
            min-height: 200px; /* Ensure minimum height for cart */
        }

        .terminal-screen ul {
            list-style: none; /* Remove default list bullets */
            padding: 0;
            margin: 0;
        }

        .terminal-screen ul li {
            border-bottom: 1px dashed #4a5568; /* Dashed line for items */
            padding: 0.5rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1rem;
        }
        .terminal-screen ul li:last-child {
            border-bottom: none;
        }

        .terminal-button {
            @apply font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-opacity-75;
            border: 2px solid;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .terminal-button.start-stop {
            @apply bg-indigo-700 hover:bg-indigo-800 text-white border-indigo-500 focus:ring-indigo-600;
        }
        .terminal-button.clear {
            @apply bg-red-700 hover:bg-red-800 text-white border-red-500 focus:ring-red-600;
        }
        .terminal-button.checkout {
            @apply bg-green-700 hover:bg-green-800 text-white border-green-500 focus:ring-green-600;
        }
        .terminal-button.modal-ok {
            @apply bg-blue-700 hover:bg-blue-800 text-white border-blue-500 focus:ring-blue-600;
        }
        .terminal-button.apply-discount {
            @apply bg-purple-700 hover:bg-purple-800 text-white border-purple-500 focus:ring-purple-600;
        }

        /* Modal styles (retained, but adjusted for consistency) */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7); /* Darker overlay */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content, .receipt-modal-content {
            background-color: #3f4a5a; /* Darker modal background */
            color: #e2e8f0;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 400px;
            text-align: center;
            position: relative;
            border: 1px solid #64748b;
        }
        .receipt-modal-content {
            max-width: 500px;
            text-align: left;
        }

        .close-button {
            color: #cbd5e0; /* Lighter close button */
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }

        /* Barcode container styling */
        .barcode-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #2d3748; /* Matches terminal body */
            border-radius: 1rem;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
            border: 1px dashed #4a5568;
            max-height: 300px; /* Limit height */
            overflow-y: auto; /* Make it scrollable */
        }
        .barcode-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.75rem;
            background-color: #1a202c; /* Darker background for individual barcodes */
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            border: 1px solid #4a5568;
        }
        .barcode-item svg {
            max-width: 150px;
            height: 80px;
            background-color: #fff; /* White background for the barcode itself */
            border-radius: 0.25rem;
        }
        .barcode-item span {
            font-size: 0.875rem;
            font-weight: 600;
            margin-top: 0.5rem;
            color: #e2e8f0;
            text-align: center;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <div class="terminal-container">
        <div class="terminal-header">
            <h1 class="text-4xl font-extrabold text-green-400 mb-2">SCAN & PAY</h1>
            <p class="text-lg text-gray-400">Code 93 Barcode Terminal</p>
        </div>

        <div class="scanner-section flex flex-col items-center gap-4">
            <div id="interactive" class="viewport bg-gray-900 relative">
                <!-- The video stream will be rendered here by QuaggaJS -->
                <div class="scanner-frame"></div>
            </div>

            <div id="result" class="bg-blue-900 text-blue-300 p-4 rounded-lg text-lg font-semibold break-words w-full text-center">
                Scan a Code 93 barcode.
            </div>

            <button id="startStopButton" class="terminal-button start-stop w-full">
                Stop Scanner
            </button>

            <div id="error-message" class="text-red-400 mt-2 font-medium hidden"></div>
        </div>

        <div class="cart-section flex flex-col">
            <h2 class="text-2xl font-bold text-gray-200 mb-4 text-center">Shopping Cart</h2>
            <div class="terminal-screen flex-grow">
                <ul id="cart-items" class="mb-4 text-gray-300">
                    <li class="text-gray-500 text-center">No items in cart.</li>
                </ul>
                <p class="text-2xl font-extrabold text-green-400 mt-auto pt-4 border-t border-gray-600">Total: <span id="cart-total">$0.00</span></p>
            </div>
        </div>

        <div class="discount-section flex flex-col items-center gap-4 p-4 bg-gray-700 rounded-lg shadow-inner">
            <h3 class="text-xl font-bold text-gray-200">Apply Discount</h3>
            <div class="flex flex-col sm:flex-row w-full gap-2">
                <input type="text" id="discountCodeInput" placeholder="Enter code (e.g., SAVE10)" class="flex-grow p-3 rounded-lg bg-gray-800 text-white border border-gray-600 focus:outline-none focus:border-blue-500">
                <button id="applyDiscountButton" class="terminal-button apply-discount">
                    Apply Discount
                </button>
            </div>
            <p id="discountStatus" class="text-sm text-gray-400"></p>
        </div>


        <div class="controls-section flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
            <button id="clearCartButton" class="terminal-button clear">
                Clear Cart
            </button>
            <button id="checkoutButton" class="terminal-button checkout">
                Checkout
            </button>
        </div>
    </div>

    <div class="w-full max-w-2xl text-center mt-8">
        <h2 class="text-2xl font-bold text-gray-200 mb-4">Generated Barcodes for Testing</h2>
        <div id="generated-barcodes" class="barcode-container">
            <!-- Generated barcodes will be inserted here -->
        </div>
    </div>

    <!-- General Message Modal -->
    <div id="messageModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="closeMessageModalButton">&times;</span>
            <p id="modal-message" class="text-lg font-semibold"></p>
            <button id="messageModalOkButton" class="mt-6 terminal-button modal-ok">OK</button>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="modal hidden">
        <div class="receipt-modal-content">
            <span class="close-button" id="closeReceiptModalButton">&times;</span>
            <h3 class="text-2xl font-bold text-green-400 mb-4 text-center">RECEIPT</h3>
            <p id="receipt-date" class="text-sm text-gray-400 mb-4 text-center"></p>
            <div class="border-t border-b border-gray-600 py-2 mb-4">
                <div class="flex justify-between font-semibold text-gray-300 mb-2">
                    <span>ITEM</span>
                    <span>PRICE</span>
                </div>
                <ul id="receipt-items" class="text-gray-300">
                    <!-- Receipt items will be listed here -->
                </ul>
            </div>
            <div class="flex justify-between text-gray-300 font-semibold mb-2">
                <span>Subtotal:</span>
                <span id="receipt-subtotal"></span>
            </div>
            <div class="flex justify-between text-gray-300 font-semibold mb-2">
                <span>Discount:</span>
                <span id="receipt-discount" class="text-red-400">-$0.00</span>
            </div>
            <div class="flex justify-between text-gray-300 font-semibold mb-2">
                <span>Tax (8%):</span>
                <span id="receipt-tax"></span>
            </div>
            <div class="flex justify-between text-xl font-bold text-green-400 pt-2 border-t border-gray-500">
                <span>TOTAL:</span>
                <span id="receipt-total"></span>
            </div>
            <p class="text-center text-sm text-gray-500 mt-6">Thank you for your business!</p>
            <button id="printReceiptButton" class="mt-6 w-full terminal-button modal-ok">Print Receipt</button>
        </div>
    </div>


    <!-- QuaggaJS library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <!-- JsBarcode library -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <!-- Tone.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>

    <script>
        // Global variables for QuaggaJS state and cart
        let isScannerRunning = false;
        let cart = []; // Array to store items in the cart
        let lastScanTime = 0; // Timestamp of the last successful scan
        const scanDelayMs = 2000; // 2-second delay between scans
        let currentDiscount = 0; // Current applied discount amount

        // Tone.js Synth for scan sound
        let scanSynth;

        // DOM elements
        const startStopButton = document.getElementById('startStopButton');
        const resultDiv = document.getElementById('result');
        const errorMessageDiv = document.getElementById('error-message');
        const cartItemsList = document.getElementById('cart-items');
        const cartTotalSpan = document.getElementById('cart-total');
        const clearCartButton = document.getElementById('clearCartButton');
        const checkoutButton = document.getElementById('checkoutButton');
        const generatedBarcodesDiv = document.getElementById('generated-barcodes');
        const discountCodeInput = document.getElementById('discountCodeInput');
        const applyDiscountButton = document.getElementById('applyDiscountButton');
        const discountStatus = document.getElementById('discountStatus');

        // General Message Modal elements
        const messageModal = document.getElementById('messageModal');
        const modalMessage = document.getElementById('modal-message');
        const closeMessageModalButton = document.getElementById('closeMessageModalButton');
        const messageModalOkButton = document.getElementById('messageModalOkButton');

        // Receipt Modal elements
        const receiptModal = document.getElementById('receiptModal');
        const closeReceiptModalButton = document.getElementById('closeReceiptModalButton');
        const receiptDate = document.getElementById('receipt-date');
        const receiptItemsList = document.getElementById('receipt-items');
        const receiptSubtotal = document.getElementById('receipt-subtotal');
        const receiptDiscount = document.getElementById('receipt-discount');
        const receiptTax = document.getElementById('receipt-tax');
        const receiptTotal = document.getElementById('receipt-total');
        const printReceiptButton = document.getElementById('printReceiptButton');

        // Fake product database (barcode -> product details)
        const products = {
            "CODE93-12345": { name: "Wireless Mouse", price: 25.99 },
            "CODE93-67890": { name: "Mechanical Keyboard", price: 79.99 },
            "CODE93-ABCDE": { name: "USB-C Hub", price: 35.50 },
            "CODE93-FGHIJ": { name: "External SSD 1TB", price: 120.00 },
            "CODE93-KLMNO": { name: "Noise-Cancelling Headphones", price: 199.99 },
            "CODE93-PQRST": { name: "Webcam 1080p", price: 49.99 },
            "CODE93-UVWXY": { name: "Monitor 27-inch", price: 299.00 },
            "CODE93-Z1234": { name: "Ergonomic Chair", price: 350.00 },
            "CODE93-56789": { name: "Smartwatch", price: 49.99 },
            "CODE93-0ABCD": { name: "Portable Speaker", price: 65.00 }
        };

        // Predefined discount codes
        const discountCodes = {
            "SAVE10": 10.00, // $10 off
            "FREESHIP": 0 // Placeholder for future free shipping logic, currently no monetary value
        };

        /**
         * Initializes the Tone.js synth for scan sounds.
         */
        function initScanSound() {
            // Create a simple synth for the beep sound
            scanSynth = new Tone.Synth().toDestination();
        }

        /**
         * Plays a short beep sound.
         */
        function playScanSound() {
            if (scanSynth) {
                // Play a C5 note for 0.1 seconds
                scanSynth.triggerAttackRelease("C5", "8n");
            }
        }

        /**
         * Displays a custom modal message.
         * @param {string} message - The message to display in the modal.
         */
        function showMessageModal(message) {
            modalMessage.textContent = message;
            messageModal.classList.remove('hidden');
            messageModal.style.display = 'flex'; // Ensure it's displayed as flex for centering
        }

        /**
         * Hides the custom modal.
         */
        function hideMessageModal() {
            messageModal.classList.add('hidden');
            messageModal.style.display = 'none';
        }

        /**
         * Displays the receipt modal.
         * @param {Array} items - Array of items in the cart.
         * @param {number} subtotal - The subtotal before tax.
         * @param {number} appliedDiscount - The actual discount amount applied.
         * @param {number} tax - The calculated tax amount.
         * @param {number} total - The final total.
         */
        function showReceiptModal(items, subtotal, appliedDiscount, tax, total) {
            receiptDate.textContent = new Date().toLocaleString();
            receiptItemsList.innerHTML = ''; // Clear previous items

            items.forEach(item => {
                const li = document.createElement('li');
                li.className = 'flex justify-between py-1 text-sm';
                li.innerHTML = `
                    <span>${item.name}</span>
                    <span>$${item.price.toFixed(2)}</span>
                `;
                receiptItemsList.appendChild(li);
            });

            receiptSubtotal.textContent = `$${subtotal.toFixed(2)}`;
            receiptDiscount.textContent = `-$${appliedDiscount.toFixed(2)}`;
            receiptTax.textContent = `$${tax.toFixed(2)}`;
            receiptTotal.textContent = `$${total.toFixed(2)}`;

            receiptModal.classList.remove('hidden');
            receiptModal.style.display = 'flex';
        }

        /**
         * Hides the receipt modal.
         */
        function hideReceiptModal() {
            receiptModal.classList.add('hidden');
            receiptModal.style.display = 'none';
        }

        // Event listeners for modal buttons
        closeMessageModalButton.addEventListener('click', hideMessageModal);
        messageModalOkButton.addEventListener('click', hideMessageModal);
        window.addEventListener('click', (event) => {
            if (event.target === messageModal) {
                hideMessageModal();
            }
            if (event.target === receiptModal) {
                hideReceiptModal();
            }
        });
        closeReceiptModalButton.addEventListener('click', hideReceiptModal);
        printReceiptButton.addEventListener('click', () => {
            // Simple print functionality for the receipt content
            const receiptContent = receiptModal.querySelector('.receipt-modal-content').outerHTML;
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Receipt</title>');
            printWindow.document.write('<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">');
            printWindow.document.write('<style>body{font-family: \'Inter\', sans-serif;}</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(receiptContent);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        });


        /**
         * Updates the display of items in the cart and the total price.
         */
        function updateCartDisplay() {
            cartItemsList.innerHTML = ''; // Clear current list
            let subtotal = 0;

            if (cart.length === 0) {
                const li = document.createElement('li');
                li.className = 'text-gray-500 text-center';
                li.textContent = 'No items in cart.';
                cartItemsList.appendChild(li);
            } else {
                cart.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center py-1';
                    li.innerHTML = `
                        <span>${item.name}</span>
                        <span class="font-medium">$${item.price.toFixed(2)}</span>
                    `;
                    cartItemsList.appendChild(li);
                    subtotal += item.price;
                });
            }

            let finalTotal = subtotal - currentDiscount;
            if (finalTotal < 0) finalTotal = 0; // Prevent negative total

            cartTotalSpan.textContent = `$${finalTotal.toFixed(2)}`;
        }

        /**
         * Clears all items from the shopping cart and resets discount.
         */
        function clearCart() {
            cart = [];
            currentDiscount = 0; // Reset discount
            discountCodeInput.value = ''; // Clear discount input
            discountStatus.textContent = ''; // Clear discount status
            updateCartDisplay();
            showMessageModal("Cart has been cleared!");
            console.log("Cart cleared.");
        }

        /**
         * Applies a discount based on the entered code.
         */
        function applyDiscount() {
            const code = discountCodeInput.value.toUpperCase().trim();
            if (discountCodes.hasOwnProperty(code)) {
                const discountValue = discountCodes[code];
                if (discountValue > 0) {
                    currentDiscount = discountValue;
                    discountStatus.textContent = `Discount of $${currentDiscount.toFixed(2)} applied!`;
                    discountStatus.className = 'text-sm text-green-400';
                    updateCartDisplay();
                    showMessageModal(`Discount code "${code}" applied: $${currentDiscount.toFixed(2)} off!`);
                } else {
                    // Handle other types of discounts like free shipping if implemented
                    discountStatus.textContent = `Code "${code}" applied (no monetary discount).`;
                    discountStatus.className = 'text-sm text-yellow-400';
                    showMessageModal(`Discount code "${code}" applied.`);
                    currentDiscount = 0; // Ensure no monetary discount if code is for something else
                }
            } else {
                currentDiscount = 0; // No valid discount
                discountStatus.textContent = "Invalid discount code.";
                discountStatus.className = 'text-sm text-red-400';
                showMessageModal("Invalid discount code. Please try again.");
            }
            updateCartDisplay(); // Update display to show potential discount
        }

        /**
         * Simulates the checkout process and generates a receipt.
         */
        function checkout() {
            if (cart.length === 0) {
                showMessageModal("Your cart is empty. Please add items before checking out.");
                return;
            }

            let subtotal = cart.reduce((sum, item) => sum + item.price, 0);
            let finalSubtotalAfterDiscount = subtotal - currentDiscount;
            if (finalSubtotalAfterDiscount < 0) finalSubtotalAfterDiscount = 0;

            const taxRate = 0.08; // 8% tax
            const tax = finalSubtotalAfterDiscount * taxRate;
            const total = finalSubtotalAfterDiscount + tax;

            showReceiptModal(cart, subtotal, currentDiscount, tax, total);

            console.log("Checkout complete. Total:", total.toFixed(2));
            cart = []; // Clear cart after checkout
            currentDiscount = 0; // Reset discount after checkout
            discountCodeInput.value = ''; // Clear discount input
            discountStatus.textContent = ''; // Clear discount status
            updateCartDisplay();
        }

        /**
         * Initializes and starts the QuaggaJS barcode scanner.
         */
        function startScanner() {
            // Initialize Tone.js audio context first (required for sound to work)
            if (Tone.context.state !== 'running') {
                Tone.start();
                console.log("Tone.js audio context started.");
            }

            // Configure QuaggaJS to use the camera and look for Code 93 barcodes
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#interactive'), // Target element for the video stream
                    constraints: {
                        width: { min: 640 },
                        height: { min: 480 },
                        facingMode: "environment" // Use the back camera if available
                    },
                },
                decoder: {
                    readers: ["code_93_reader"], // Specify Code 93 reader
                    debug: {
                        drawBoundingBox: true,
                        showFrequency: false,
                        drawScanline: true,
                        showPattern: false
                    }
                },
                locate: true // Enable location of the barcode in the stream
            }, function(err) {
                if (err) {
                    console.error("Quagga initialization error:", err);
                    resultDiv.textContent = "Error initializing scanner. Please check console for details.";
                    errorMessageDiv.textContent = `Error: ${err.message || err}. Please ensure camera access is granted.`;
                    errorMessageDiv.classList.remove('hidden');
                    startStopButton.textContent = "Start Scanner"; // Change button text if auto-start fails
                    return;
                }
                console.log("Initialization finished. Ready to start");
                Quagga.start(); // Start the scanner
                isScannerRunning = true;
                startStopButton.textContent = "Stop Scanner";
                resultDiv.textContent = "Scanning...";
                errorMessageDiv.classList.add('hidden'); // Hide error message on successful start
                lastScanTime = 0; // Reset scan time when scanner starts
            });

            // Event listener for when a barcode is detected
            Quagga.onDetected(function(data) {
                const currentTime = Date.now();
                // Implement scanning delay
                if (currentTime - lastScanTime < scanDelayMs) {
                    console.log("Scan ignored due to delay.");
                    return; // Ignore scan if within the delay period
                }

                if (data && data.codeResult && data.codeResult.code) {
                    const scannedCode = data.codeResult.code;
                    resultDiv.textContent = `Detected Code 93: ${scannedCode}`;

                    // Check if the scanned code exists in our fake product database
                    const product = products[scannedCode];
                    if (product) {
                        cart.push(product); // Add product to cart
                        updateCartDisplay(); // Update the cart display
                        showMessageModal(`${product.name} ($${product.price.toFixed(2)}) added to cart!`);
                        playScanSound(); // Play sound on successful scan
                        lastScanTime = currentTime; // Update last scan time
                    } else {
                        showMessageModal(`Product with barcode "${scannedCode}" not found.`);
                    }
                }
            });

            // Event listener for when a frame is processed (useful for drawing bounding boxes)
            Quagga.onProcessed(function(result) {
                const drawingCtx = Quagga.canvas.ctx.overlay;
                const drawingCanvas = Quagga.canvas.dom.overlay;

                if (result) {
                    if (result.boxes) {
                        drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.width), parseInt(drawingCanvas.height));
                        result.boxes.filter(function (box) {
                            return box !== result.box;
                        }).forEach(function (box) {
                            Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
                        });
                    }

                    if (result.box) {
                        Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "#00F", lineWidth: 2});
                    }

                    if (result.codeResult && result.codeResult.code) {
                        Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: "red", lineWidth: 3});
                    }
                }
            });
        }

        /**
         * Stops the QuaggaJS barcode scanner.
         */
        function stopScanner() {
            if (isScannerRunning) {
                Quagga.stop(); // Stop the scanner
                isScannerRunning = false;
                startStopButton.textContent = "Start Scanner";
                resultDiv.textContent = "Scanner stopped. Click 'Start Scanner' to resume.";
                console.log("Scanner stopped.");
            }
        }

        /**
         * Generates and displays Code 93 barcodes for all products in the database.
         */
        function generateBarcodes() {
            generatedBarcodesDiv.innerHTML = ''; // Clear existing barcodes
            for (const barcode in products) {
                if (products.hasOwnProperty(barcode)) {
                    const product = products[barcode];
                    const barcodeItemDiv = document.createElement('div');
                    barcodeItemDiv.className = 'barcode-item';

                    const svgElement = document.createElement('svg');
                    svgElement.id = `barcode-${barcode}`; // Unique ID for each SVG
                    barcodeItemDiv.appendChild(svgElement);

                    const productNameSpan = document.createElement('span');
                    productNameSpan.textContent = product.name;
                    barcodeItemDiv.appendChild(productNameSpan);

                    generatedBarcodesDiv.appendChild(barcodeItemDiv);

                    // Use JsBarcode to render the barcode
                    JsBarcode(`#barcode-${barcode}`, barcode, {
                        format: "CODE93",
                        lineColor: "#000",
                        width: 2,
                        height: 60,
                        displayValue: true,
                        fontSize: 12,
                        textMargin: 5
                    });
                }
            }
        }

        // Event listeners for buttons
        startStopButton.addEventListener('click', function() {
            if (isScannerRunning) {
                stopScanner();
            } else {
                startScanner();
            }
        });

        clearCartButton.addEventListener('click', clearCart);
        checkoutButton.addEventListener('click', checkout);
        applyDiscountButton.addEventListener('click', applyDiscount);

        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', () => {
            initScanSound(); // Initialize Tone.js synth
            updateCartDisplay(); // Initialize cart display
            generateBarcodes(); // Generate barcodes on page load
            startScanner(); // Auto-start the scanner
        });
    </script>
</body>
</html>
